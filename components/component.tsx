"use client"

/**
 * This code was generated by v0 by Vercel.
 * @see https://v0.dev/t/a8jwOhO9bv9
 */
import { TableHead, TableRow, TableHeader, TableCell, TableBody, Table } from "@/components/ui/table"
import { TabsTrigger, TabsList, TabsContent, Tabs } from "@/components/ui/tabs"
import { CardTitle, CardDescription, CardHeader, CardContent, Card } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"

import '@polkadot/api-augment'
import React, { useState } from 'react'
import { GearKeyring } from '@gear-js/api'
import { encodeAddress } from '@polkadot/util-crypto'
import useSWR, { mutate } from 'swr'
import { CodeBlock, CopyBlock, dracula } from 'react-code-blocks'

const register = async (address: string) => {
  const res = await fetch(`/api/register/${address}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ address }),
  });

  if (!res.ok) {
    const errorData = await res.json();
    throw new Error(`Failed to register for auction: ${errorData.message}`);
  }

  return res.json();
};

enum Progress {
  ACCOUNT = 1,
  REGISTER,
  PROOF,
  BID,
}

export function Component() {
  const [account, setAccount] = useState<null | { address: string; keyring: GearKeyring; }>(null);
  const [message, setMessage] = useState<null | string>(null);
  const [progress, setProgress] = useState<Progress>(Progress.ACCOUNT);
  const [selectedTab, setSelectedTab] = useState<string>('account');

  const generateAccount = async () => {
    const {keyring} = await GearKeyring.create('seed');
    
    const newAccount = {
      address: encodeAddress(keyring.publicKey, 137),
      keyring: keyring,
    };

    setAccount(newAccount);
    setProgress(Progress.REGISTER);
    setMessage(null);
    setTimeout(()=>setSelectedTab('register'), 1000);
  };

  const registerForAuction = async () => {
    setMessage(null);

    if (!account) {
      setMessage('Error: no account to register for auction. Go generate an account first.');
      return;
    }

    try {
      const data = await mutate([account.address], register(account.address), false);
      setMessage(`${JSON.stringify(data, null, "  ")}`);
      setProgress(Progress.PROOF);
      setTimeout(()=>setSelectedTab('proof'), 1000);
    } catch (error) {
      setMessage(`Error registering for auction: ${error}`);
      setProgress(Progress.REGISTER);
    }
  };

  const generateProof = async () => {
    setProgress(Progress.BID);
    setTimeout(()=>setSelectedTab('bid'), 1000);
  };

  const placeBid = async () => {
    window.alert('Not implemented');
  };

  const code = `# set the secret key of the main funding account
export SURI="abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon cactus"

# install the zkBid CLI
cargo install zkbid-cli

# generate a proof that the main account has enough funds to place a bid, for example, 42 VARA
# you should replace the price with the actual price you want to bid
# the proof will be saved to proof.txt
zkbid proof --suri "$SURI" --price 42 > proof.txt`;

  return (
    <div>
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead className="font-bold text-center" colSpan={4}>
              All Existing Bids
            </TableHead>
          </TableRow>
          <TableRow>
            <TableHead>Bidder</TableHead>
            <TableHead>Price (VARA)</TableHead>
            <TableHead>Bidding Time</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          <TableRow>
            <TableCell>kG8d3e3e...</TableCell>
            <TableCell>500</TableCell>
            <TableCell>2024-02-20 15:30:45</TableCell>
          </TableRow>
          <TableRow>
            <TableCell>kG5a1b2c...</TableCell>
            <TableCell>700</TableCell>
            <TableCell>2024-02-20 14:20:10</TableCell>
          </TableRow>
          <TableRow>
            <TableCell>kGf4e7d2...</TableCell>
            <TableCell>1000</TableCell>
            <TableCell>2024-02-20 12:45:30</TableCell>
          </TableRow>
        </TableBody>
      </Table>
      <Tabs  className="w-full overflow-x-auto" defaultValue="account" value={selectedTab} onValueChange={setSelectedTab}>
        <TabsList className="grid grid-cols-4 gap-4">
          <TabsTrigger value="account" disabled={progress < Progress.ACCOUNT}>Generate Account</TabsTrigger>
          <TabsTrigger value="register" disabled={progress < Progress.REGISTER}>Register for Auction</TabsTrigger>
          <TabsTrigger value="proof" disabled={progress < Progress.PROOF}>Generate Proof</TabsTrigger>
          <TabsTrigger value="bid" disabled={progress < Progress.BID}>Place Bid</TabsTrigger>
        </TabsList>
        <TabsContent value="account">
          <Card>
            <CardHeader>
              <CardTitle>Generate Account</CardTitle>
              <CardDescription>
                Creates a keypair for a temporary account and stores it on the frontend.
              </CardDescription>
            </CardHeader>
            <CardContent className="grid gap-4">
              {account && (
                <div className="flex items-center gap-2">
                  <Input className="w-full" id="address" readOnly type="text" value={account.address} />
                </div>
              )}
              <Button onClick={generateAccount}>Generate Account</Button>
            </CardContent>
          </Card>
        </TabsContent>
        <TabsContent value="register">
          <Card>
            <CardHeader>
              <CardTitle>Register for Auction</CardTitle>
              <CardDescription>Sends an HTTPS request to the backend to fetch a voucher.</CardDescription>
            </CardHeader>
            <CardContent className="grid gap-4">
              {account && (
                <div className="flex items-center gap-2">
                  <Input className="w-full" id="address" readOnly type="text" value={account.address} />
                </div>
              )}
              {message && <CodeBlock text={message} language={"json"} showLineNumbers={false} wrapLongLines theme={dracula} />}
              <Button onClick={registerForAuction}>Register for Auction</Button>
            </CardContent>
          </Card>
        </TabsContent>
	      <TabsContent value="proof">
          <Card>
            <CardHeader>
              <CardTitle>Generate Proof</CardTitle>
              <CardDescription>Takes private key of main account(one that is funded) and generates proof that it have enough funds to place a bid. Instructions for generating proof locally:</CardDescription>
            </CardHeader>
            <CardContent className="grid gap-4">
            <CopyBlock language={"bash"} text={code} showLineNumbers wrapLongLines theme={dracula} />
            <Button onClick={generateProof}>I have generated the proof</Button>
            </CardContent>
          </Card>
        </TabsContent>
        <TabsContent value="bid">
          <Card>
            <CardHeader>
              <CardTitle>Place Bid</CardTitle>
              <CardDescription>
                Sends a message to the auction contract using the fetched voucher and generated account.
              </CardDescription>
            </CardHeader>
            <CardContent className="grid gap-4">
              {account && (
                <div className="flex items-center gap-2">
                  <Input className="w-full" id="address" readOnly type="text" value={account.address} />
                </div>
              )}
              <Input id="price" placeholder="Enter price" type="number" />
              <Textarea id="funding-proof" placeholder="Enter funding proof (0x...)" />
              <div className="flex items-center justify-end space-x-4">
                <Label className="" htmlFor="upload-proof">
                  Or upload proof from file
                </Label>
                <Input className="hidden" id="upload-proof" type="file" />
              </div>
              <Button onClick={placeBid}>Place Bid</Button>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  )
}
